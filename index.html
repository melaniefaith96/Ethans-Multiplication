<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Beat Multiply</title>
<style>
/* ========== THEME VARIABLES ========== */
:root{
  --bg1:#2c3e50; --bg2:#3498db; --accent:#b2e0ff; --text:#f0f0f0;
  --correct:#a3ffae; --correctGlow:#2ad04a; --wrong:#ff7f7f; --wrongGlow:#d02020;
  --star:#ffffff; --trail:#ffffff;
}
body.theme-space{ --bg1:#0b1020; --bg2:#204090; --accent:#b2e0ff; --star:#dfe9ff; --trail:#bcd4ff;}
body.theme-underwater{ --bg1:#002b36; --bg2:#0aa; --accent:#a0ffe5; --star:#a8f0ff; --trail:#7fffd4;}
body.theme-neon{ --bg1:#1a0026; --bg2:#ff00aa; --accent:#ffe680; --star:#fffbf0; --trail:#ffcc00;}

/* ========== BASE ========== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family: 'Arial', sans-serif;
  color: var(--text);
  display:flex; justify-content:center; align-items:center; flex-direction:column;
  height:100vh; margin:0; user-select:none; overflow:hidden; position:relative;
  background: linear-gradient(135deg, var(--bg1), var(--bg2));
  background-size: 400% 400%; animation: gradientBG 15s ease infinite;
  transition: background-color .3s;
}
@keyframes gradientBG {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

#uiTop{
  position:fixed; top:12px; left:12px; right:12px; display:flex; gap:10px; align-items:center; justify-content:space-between; z-index:20;
}
select, button{
  padding:10px 14px; font-size:1rem; border:none; border-radius:10px; cursor:pointer; background:#2980b9; color:white;
  box-shadow:0 0 10px #2980b9; transition:transform .15s, background .3s;
}
button:hover, select:hover{ transform:scale(1.03) }
button:active{ transform:scale(.97) }
select{ background:#3a3a3a; box-shadow:0 0 10px #00000055 }

#startScreen{text-align:center; margin-bottom:20px; z-index:10;}
#countdown{
  font-size: 4em; margin-top:20px; color:var(--accent);
  text-shadow:0 0 8px #7fbfff99; z-index:10; animation:pulse 1s infinite;
}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
.question{
  font-size:2.6em; margin:10px 0 14px; text-shadow:0 0 6px #0d1f3f; z-index:10;
}
.answer-input{
  padding:10px; font-size:1.6em; width:120px; text-align:center;
  border-radius:10px; border:none; outline:none; box-shadow:0 0 8px rgba(255 255 255 / .3); z-index:10;
}
.answer-input:focus{ box-shadow:0 0 14px var(--accent); background:#d6eaff; color:#003366; font-weight:bold; }
.feedback{
  margin-top:15px; font-size:1.5em; height:1.5em; min-height:1.5em; user-select:none; z-index:10;
  text-shadow:0 0 4px #00000090; transition:transform .3s;
}
.feedback.correct{ color:var(--correct); text-shadow:0 0 10px var(--correctGlow); }
.feedback.wrong{ color:var(--wrong); text-shadow:0 0 10px var(--wrongGlow); }
.score{ margin-top:16px; font-weight:bold; text-shadow:0 0 8px #0d1f3f; z-index:10; }

.flash-correct{ animation: flashGreen .4s alternate 4 }
.flash-wrong{ animation: flashRed .3s alternate 4 }
@keyframes flashGreen{ 0%{background-color:var(--bg1)} 100%{ background-color:#2ecc71}}
@keyframes flashRed{ 0%{background-color:var(--bg1)} 100%{ background-color:#e74c3c}}

#confetti{ pointer-events:none; position:fixed; inset:0; width:100vw; height:100vh; overflow:visible; z-index:9999;}
.confetti-piece{ position:absolute; width:10px; height:10px; border-radius:2px; opacity:.9; will-change:transform,opacity; }

/* STAR FIELD (above canvas bg) */
#stars{ position:fixed; inset:0; pointer-events:none; z-index:1;}
.star{ position:absolute; width:2px; height:2px; background: var(--star); border-radius:50%; opacity:0;
  animation: twinkle 2s infinite ease-in-out, drift linear infinite; }
@keyframes twinkle{ 0%,100%{opacity:.2} 50%{opacity:1}}
@keyframes drift{ 0%{ transform: translateY(0)} 100%{ transform: translateY(-110vh)} }

/* MULT TABLE CANVAS sits behind stars */
#bgTable{ position:fixed; inset:0; z-index:0; pointer-events:none; }

/* CURSOR PARTICLE TRAILS */
.particle{
  position:fixed; width:8px; height:8px; border-radius:50%;
  background: var(--trail); pointer-events:none; filter:blur(0.5px); opacity:.9; z-index:15;
  animation: particleFade .6s ease-out forwards;
}
@keyframes particleFade{ to{ transform:translateY(-10px) scale(.6); opacity:0 }}

/* STREAK METER */
#streakWrap{
  position:fixed; bottom:14px; left:50%; transform:translateX(-50%);
  width:min(700px, 80vw); height:18px; background:#00000050; border-radius:999px;
  box-shadow: inset 0 0 8px #000000aa, 0 0 10px #00000066; overflow:hidden; z-index:20;
}
#streakBar{
  width:0%; height:100%;
  background: linear-gradient(90deg, #ffdd55, #ff9933, #ff3366);
  box-shadow: 0 0 18px #ff6a00aa, inset 0 0 10px #ffffff88;
  animation: flamePulse 1.2s ease-in-out infinite alternate;
  transform-origin:left center;
}
@keyframes flamePulse{ from{filter:brightness(1)} to{filter:brightness(1.4)} }
#streakLabel{
  position:absolute; right:10px; top:-24px; font-size:.95rem; opacity:.9; text-shadow:0 0 6px #000;
}

/* Pop animation on correct */
.pop-bounce{ animation: popBounce .35s ease-out }
@keyframes popBounce{
  0%{ transform:scale(1) }
  50%{ transform:scale(1.18) }
  100%{ transform:scale(1) }
}

/* Celebration text */
#celebration-text{
  position: fixed; top:40%; left:50%; transform:translate(-50%, -50%);
  font-size:5em; font-weight:bold; color: yellow; text-shadow:0 0 20px #ff0000;
  display:none; z-index:10000; animation: flashText .5s alternate 10;
}
@keyframes flashText{0%{opacity:0}100%{opacity:1}}
</style>
</head>
<body class="theme-space">
<!-- THEME / CONTROLS -->
<div id="uiTop" aria-label="Game controls">
  <div style="display:flex; gap:10px; align-items:center;">
    <button id="startBtn" aria-label="Start game">Start Game</button>
    <button id="stopBtn" aria-label="Stop music">Stop Music</button>
  </div>
  <label>
    Theme:
    <select id="themeSelect" aria-label="Theme switcher">
      <option value="space">Space</option>
      <option value="underwater">Underwater</option>
      <option value="neon">Neon</option>
    </select>
  </label>
</div>

<!-- BG canvas for multiplication table -->
<canvas id="bgTable"></canvas>

<!-- Stars layer -->
<div id="stars" aria-hidden="true"></div>

<!-- Start & Game UI -->
<div id="startScreen">
  <div id="countdown" style="display:none;"></div>
</div>

<div class="question" id="question" style="display:none;" aria-live="polite"></div>
<input type="number" id="answer" class="answer-input" placeholder="?" autofocus style="display:none;" aria-label="Type your answer and press Enter"/>
<div class="feedback" id="feedback" aria-live="polite"></div>
<div class="score" id="score" style="display:none;">Score: 0</div>

<!-- Streak meter -->
<div id="streakWrap" aria-hidden="false" title="Answer streak">
  <div id="streakBar"></div>
  <div id="streakLabel">Streak: 0</div>
</div>

<!-- Effects -->
<div id="confetti" aria-hidden="true"></div>
<div id="celebration-text">YOU DID IT!</div>

<!-- Audio -->
<audio id="beat" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" loop hidden></audio>

<!-- Alternate correct sounds -->
<audio class="correctSfx" src="https://freesound.org/data/previews/170/170664_2437358-lq.mp3" preload="auto"></audio>
<audio class="correctSfx" src="https://freesound.org/data/previews/320/320655_5260873-lq.mp3" preload="auto"></audio>
<audio class="correctSfx" src="https://freesound.org/data/previews/109/109662_945474-lq.mp3" preload="auto"></audio>

<!-- Celebration sound (still used at 50 points) -->
<audio id="celebrationSound" src="https://freesound.org/data/previews/331/331912_3248244-lq.mp3" preload="auto"></audio>

<script>
/* ====== STARS ====== */
const starsContainer = document.getElementById('stars');
for(let i=0;i<120;i++){
  const star = document.createElement('div');
  star.classList.add('star');
  star.style.left = Math.random()*100 + "vw";
  star.style.top = Math.random()*100 + "vh";
  const s = (Math.random()*2+1);
  star.style.width = star.style.height = s + "px";
  star.style.animationDuration = (5 + Math.random()*5) + "s, " + (8 + Math.random()*10) + "s"; // twinkle, drift
  starsContainer.appendChild(star);
}

/* ====== ELEMENTS ====== */
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const countdownEl = document.getElementById('countdown');
const questionEl = document.getElementById('question');
const answerEl = document.getElementById('answer');
const feedbackEl = document.getElementById('feedback');
const scoreEl = document.getElementById('score');
const beat = document.getElementById('beat');
const celebrationSound = document.getElementById('celebrationSound');
const confettiContainer = document.getElementById('confetti');
const celebrationText = document.getElementById('celebration-text');
const themeSelect = document.getElementById('themeSelect');
const streakBar = document.getElementById('streakBar');
const streakLabel = document.getElementById('streakLabel');
const correctSfx = Array.from(document.querySelectorAll('.correctSfx'));

/* ====== GAME STATE ====== */
let num1,num2,correctAnswer,score=0,feedbackTimeout, streak=0;
const messages = ["Way to go!","Almost there!","Keep going!","You can do this, Ethan!"];

/* ====== THEME SWITCHER ====== */
function applyTheme(theme){
  document.body.classList.remove('theme-space','theme-underwater','theme-neon');
  document.body.classList.add(`theme-${theme}`);
  localStorage.setItem('bm-theme', theme);
}
themeSelect.addEventListener('change', e => applyTheme(e.target.value));
const savedTheme = localStorage.getItem('bm-theme') || 'space';
themeSelect.value = savedTheme; applyTheme(savedTheme);

/* ====== BACKGROUND MULTIPLICATION TABLE (CANVAS) ====== */
const bg = document.getElementById('bgTable');
const ctx = bg.getContext('2d');
let W=bg.width=window.innerWidth, H=bg.height=window.innerHeight;
window.addEventListener('resize', ()=>{ W=bg.width=window.innerWidth; H=bg.height=window.innerHeight; initFloaters(); });

const floaters=[];
function initFloaters(){
  floaters.length=0;
  const count = Math.floor((W*H)/55000); // density
  for(let i=0;i<count;i++){
    floaters.push({
      x: Math.random()*W,
      y: Math.random()*H,
      vy: 0.2 + Math.random()*0.6,
      text: `${1+Math.floor(Math.random()*12)}×${1+Math.floor(Math.random()*12)}`,
      size: 14 + Math.random()*24,
      alpha: 0.04 + Math.random()*0.07,
      rot: (Math.random()*0.6 - 0.3)
    });
  }
}
function drawBG(){
  ctx.clearRect(0,0,W,H);
  for(const f of floaters){
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.rotate(f.rot);
    ctx.globalAlpha = f.alpha;
    ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--star').trim() || '#fff';
    ctx.font = `bold ${f.size}px Arial`;
    ctx.fillText(f.text, 0, 0);
    ctx.restore();
    f.y -= f.vy;
    if(f.y < -30){ f.y = H+30; f.x = Math.random()*W; f.text = `${1+Math.floor(Math.random()*12)}×${1+Math.floor(Math.random()*12)}`; }
  }
  requestAnimationFrame(drawBG);
}
initFloaters(); drawBG();

/* ====== PARTICLE TRAILS ====== */
let lastParticleTime = 0;
window.addEventListener('mousemove', (e)=>{
  const now = performance.now();
  if(now - lastParticleTime < 18) return; // throttle
  lastParticleTime = now;
  const p = document.createElement('div');
  p.className = 'particle';
  p.style.left = (e.clientX - 4) + 'px';
  p.style.top  = (e.clientY - 4) + 'px';
  document.body.appendChild(p);
  setTimeout(()=> p.remove(), 700);
});

/* ====== CONFETTI ====== */
function celebrateConfetti(count=150){
  const colors=['#f94144','#f3722c','#f9c74f','#90be6d','#577590','#43aa8b','#f9844a'];
  for(let i=0;i<count;i++){
    const c=document.createElement('div');
    c.classList.add('confetti-piece');
    c.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
    c.style.left=Math.random()*window.innerWidth+'px';
    c.style.top='-10px';
    c.style.width=(5+Math.random()*8)+'px';
    c.style.height=(5+Math.random()*8)+'px';
    c.style.opacity=Math.random()*0.9+0.1;
    c.style.transform=`rotate(${Math.random()*360}deg)`;
    confettiContainer.appendChild(c);
    const fallDuration = 3000 + Math.random()*2000;
    c.animate(
      [{transform: c.style.transform+' translateY(0)',opacity:1},
       {transform: c.style.transform+` translateY(${window.innerHeight+20}px)`,opacity:0}],
      {duration:fallDuration,easing:'ease-out',fill:'forwards'}
    );
    setTimeout(()=>{c.remove();},fallDuration);
  }
}

/* ====== QUESTION GENERATION ====== */
function generateQuestion(){
  num1=Math.floor(Math.random()*12)+1;
  num2=Math.floor(Math.random()*12)+1;
  correctAnswer=num1*num2;
  questionEl.textContent=`${num1} × ${num2} = ?`;
  answerEl.value='';
  feedbackEl.textContent='';
  feedbackEl.className='feedback';
  answerEl.focus();
}

/* ====== STREAK / SCORE UI ====== */
function updateStreakUI(){
  const goal = 20; // visualize up to 20-in-a-row; cap at 100%
  const pct = Math.min(100, (streak/goal)*100);
  streakBar.style.width = pct + '%';
  streakBar.style.filter = `hue-rotate(${Math.min(180, streak*8)}deg) brightness(${1 + Math.min(1, streak/20)})`;
  streakLabel.textContent = `Streak: ${streak}`;
}

/* ====== MUSIC TEMPO (Pitch Shift) ====== */
function updatePlaybackRate(){
  // base 1.0 + scale with score, clamped; slower on wrong is applied ad-hoc then restored here
  const target = Math.min(1.5, 1 + score*0.01);
  beat.playbackRate = target;
}

/* ====== VOICE ENCOURAGEMENT ====== */
const encouragements = [
  "Great job!",
  "Keep it up!",
  "You're on fire!",
  "Amazing focus!",
  "Math master!"
];
function speakEncouragement(){
  if(!('speechSynthesis' in window)) return;
  const phrase = encouragements[Math.floor(Math.random()*encouragements.length)];
  const u = new SpeechSynthesisUtterance(phrase);
  u.rate = 1.1; u.pitch = 1; u.volume = 0.9;
  speechSynthesis.cancel(); // avoid queueing up
  speechSynthesis.speak(u);
}

/* ====== INPUT HANDLER ====== */
answerEl.addEventListener('keydown',(e)=>{
  if(e.key==='Enter'){
    clearTimeout(feedbackTimeout);
    const userAnswer=parseInt(answerEl.value);
    if(userAnswer===correctAnswer){
      // feedback + FX
      feedbackEl.textContent='✅ Correct!';
      feedbackEl.className='feedback correct';
      questionEl.classList.remove('pop-bounce');
      // trigger pop animation
      void questionEl.offsetWidth; // reflow to restart animation
      questionEl.classList.add('pop-bounce');

      score++;
      streak++;
      document.body.classList.remove('flash-wrong');
      document.body.classList.add('flash-correct');

      // Alternate correct sfx
      const sfx = correctSfx[Math.floor(Math.random()*correctSfx.length)];
      try { sfx.currentTime=0; sfx.play(); } catch{}

      updatePlaybackRate();
      scoreEl.textContent=`Score: ${score}`;
      updateStreakUI();

      // Milestones
      if(score%10===0){
        const msg=messages[(score/10-1)%messages.length];
        feedbackEl.textContent=`✅ Correct! ${msg}`;
      }
      if(streak>0 && streak%5===0){ speakEncouragement(); }

      if(score===50){
        celebrationSound.currentTime=0; celebrationSound.play();
        for(let i=0;i<3;i++){ setTimeout(()=>celebrateConfetti(200), i*700); }
        celebrationText.style.display='block';
        setTimeout(()=>{celebrationText.style.display='none';},3500);
      }

      feedbackTimeout=setTimeout(()=>{
        document.body.classList.remove('flash-correct');
        generateQuestion();
      },1000);

    }else{
      // wrong
      feedbackEl.textContent=`❌ Wrong (Ans: ${correctAnswer})`;
      feedbackEl.className='feedback wrong';
      score=Math.max(0,score-1);
      streak = 0;
      updateStreakUI();

      // briefly slow down music for drama
      beat.playbackRate = 0.7;
      setTimeout(updatePlaybackRate, 600);

      document.body.classList.remove('flash-correct');
      document.body.classList.add('flash-wrong');
      scoreEl.textContent=`Score: ${score}`;

      feedbackTimeout=setTimeout(()=>{
        document.body.classList.remove('flash-wrong');
        generateQuestion();
      },1500);
    }
  }
});

/* ====== COUNTDOWN ====== */
function startCountdown(seconds,onComplete){
  countdownEl.style.display='block';
  let counter=seconds;
  countdownEl.textContent=counter;
  const interval=setInterval(()=>{
    counter--;
    if(counter>0){countdownEl.textContent=counter;}
    else{
      countdownEl.textContent='Go!';
      clearInterval(interval);
      setTimeout(()=>{countdownEl.style.display='none'; onComplete();},800);
    }
  },1000);
}

/* ====== START / STOP ====== */
startBtn.addEventListener('click', async ()=>{
  try { await beat.play(); } catch(e) { /* user gesture may be needed; startBtn is a gesture */ }
  startBtn.disabled=true; stopBtn.disabled=false;
  score=0; streak=0; updateStreakUI(); updatePlaybackRate();
  scoreEl.textContent='Score: 0';

  startCountdown(3,()=>{
    document.getElementById('startScreen').style.display='none';
    questionEl.style.display='block';
    answerEl.style.display='block';
    scoreEl.style.display='block';
    generateQuestion();
    answerEl.focus();
  });
});
stopBtn.addEventListener('click',()=>{ beat.pause(); beat.currentTime=0; });

/* ====== ACCESSIBILITY: focus answer on click anywhere ====== */
window.addEventListener('pointerdown', ()=> { if(answerEl.style.display!=='none') answerEl.focus(); });

/* ====== INIT ====== */
updateStreakUI();
</script>
</body>
</html>
